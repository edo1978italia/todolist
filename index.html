<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>TO BUY LIST EDO</title>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" />
        <link rel="stylesheet" href="styles.css" />
    </head>
    <body>
        <div id="authContainer">
            <div class="input-group">
                <input type="email" id="emailInput" placeholder="Email" />
            </div>
            <div class="input-group">
                <input type="password" id="passwordInput" placeholder="Password" />
            </div>
            <button onclick="loginUser()">Login</button>
            <p id="userInfo"></p>
        </div>

        <div id="mainContainer">
            <div id="header">
                <button onclick="logoutUser()">Logout</button>
            </div>

            <div id="inputContainer">
                <input type="text" id="taskInput" placeholder="Add a task" />
                <input type="url" id="linkInput" placeholder="Link prodotto (opzionale)" />
                <button onclick="addTask()">Add</button>
            </div>

            <div id="listContainer">
                <ul id="taskList"></ul>
            </div>

            <div id="extraBox">
                <p>E IO PAGO!</p>
            </div>
        </div>

        <!-- Modale di modifica -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeEditModal()">&times;</span>
                <h2>Modifica prodotto</h2>
                <label for="editNameInput">Nome prodotto:</label>
                <input type="text" id="editNameInput" placeholder="Nome prodotto" />

                <label for="editLinkInput">Link prodotto (opzionale):</label>
                <input type="url" id="editLinkInput" placeholder="Inserisci il link al prodotto" />

                <button onclick="saveTaskChanges()">Salva</button>
            </div>
        </div>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
            import {
                getAuth,
                signInWithEmailAndPassword,
                signOut,
                onAuthStateChanged
            } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
            import {
                getFirestore,
                collection,
                addDoc,
                doc,
                updateDoc,
                deleteDoc,
                onSnapshot,
                getDoc
            } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

            const firebaseConfig = {
                apiKey: "AIzaSyCLg-Z9YOrjsqe3PTN0Nr2C1jZotVKfI38",
                authDomain: "todolistedo.firebaseapp.com",
                projectId: "todolistedo",
                storageBucket: "todolistedo.appspot.com",
                messagingSenderId: "700684050233",
                appId: "1:700684050233:web:755d10254e8c2cf222d2e8",
                measurementId: "G-HR8GGBGQTJ"
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            function updateUI(user) {
                const authContainer = document.getElementById("authContainer");
                const mainContainer = document.getElementById("mainContainer");

                if (user) {
                    authContainer.style.display = "none";
                    mainContainer.style.display = "block";
                    loadTasks();
                } else {
                    authContainer.style.display = "block";
                    mainContainer.style.display = "none";
                }
            }

            onAuthStateChanged(auth, (user) => {
                updateUI(user);
            });

            function loadTasks() {
                onSnapshot(collection(db, "tasks"), (snapshot) => {
                    let tasksHtml = "";
                    snapshot.docs.reverse().forEach((docSnapshot) => {
                        let task = docSnapshot.data();
                        tasksHtml += `<li class="task-item">
                            <span class="task-text ${task.completed ? "completed" : ""}">${task.name}</span>
                            <div class="task-buttons">
                                ${task.link ? `<button class="link-button" onclick="window.open('${task.link}', '_blank')">ðŸ”´</button>` : ""}
                                <button onclick="toggleComplete('${docSnapshot.id}', ${task.completed})">âœ”</button>
                                <button onclick="editTask('${docSnapshot.id}')">ðŸ–‰</button>
                                <button onclick="deleteTask('${docSnapshot.id}')"> ðŸ—‘ </button>
                            </div>
                        </li>`;
                    });
                    document.getElementById("taskList").innerHTML = tasksHtml;
                });
            }

            window.addTask = async function () {
                const taskInput = document.getElementById("taskInput").value.trim();
                const linkInput = document.getElementById("linkInput").value.trim();
                if (!taskInput) return alert("Inserisci un task valido!");
                await addDoc(collection(db, "tasks"), {
                    name: taskInput,
                    link: linkInput || ""
                });
                document.getElementById("taskInput").value = "";
                document.getElementById("linkInput").value = "";
            };

            let currentTaskId = null;
            window.editTask = async function (id) {
                currentTaskId = id;
                const taskRef = doc(db, "tasks", id);
                const taskSnapshot = await getDoc(taskRef);

                if (taskSnapshot.exists()) {
                    const taskData = taskSnapshot.data();
                    document.getElementById("editNameInput").value = taskData.name;
                    document.getElementById("editLinkInput").value = taskData.link || "";
                    document.getElementById("editModal").style.display = "flex";
                }
            };

            window.closeEditModal = function () {
                document.getElementById("editModal").style.display = "none";
            };

            window.saveTaskChanges = async function () {
                const newName = document.getElementById("editNameInput").value;
                const newLink = document.getElementById("editLinkInput").value;

                if (currentTaskId && newName) {
                    await updateDoc(doc(db, "tasks", currentTaskId), { 
                        name: newName, 
                        link: newLink 
                    });
                }

                closeEditModal();
            };

            window.deleteTask = async function (id) { /* Elimina il task dal database */ };
            window.toggleComplete = async function (id, currentState) { /* Cambia stato completato */ };
            window.logoutUser = async function () { /* Logout utente */ };
        </script>
    </body>
</html>
