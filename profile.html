<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Profilo Utente</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- Firebase (non-module) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <!-- Cloudinary -->
  <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>

  <style>
    .avatar {
      width: 96px;
      height: 96px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #ccc;
      margin: 12px 0;
    }
  </style>
</head>
<body>
  <div id="profile-container">
    <h2>Your Profile</h2>

    <p><strong>Email:</strong> <span id="userEmail"></span></p>

    <label for="displayName">Set your name:</label><br />
    <input type="text" id="displayName" placeholder="Enter your name" /><br /><br />

    <img id="avatarPreview" src="default.png" alt="Avatar" class="avatar" />
    <br />
    <button id="upload_widget">ğŸ“· Change your profile picture</button>
    <br /><br />
    <button id="saveProfile">ğŸ’¾ Save</button>
    <br /><br />
    <button id="goBackButton">â†©ï¸ Back</button>
  </div>

  <script>
  const firebaseConfig = {
    apiKey: "API_KEY",
    authDomain: "PROJECT_ID.firebaseapp.com",
    projectId: "PROJECT_ID",
    storageBucket: "PROJECT_ID.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  document.getElementById("goBackButton").addEventListener("click", () => {
    if (document.referrer && !document.referrer.includes("profile.html")) {
      history.back();
    } else {
      window.location.href = "index.html";
    }
  });

  auth.onAuthStateChanged(async user => {
    if (user) {
      document.getElementById("userEmail").textContent = user.email;
      const userRef = db.collection("users").doc(user.uid);
      const snap = await userRef.get();
      const data = snap.data();
      if (data) {
        if (data.displayName) {
          document.getElementById("displayName").value = data.displayName;
        }
        if (data.photoURL) {
          document.getElementById("avatarPreview").src = data.photoURL;
        }
      }
    }
  });

  const widget = cloudinary.createUploadWidget({
    cloudName: "dpj6s7xvh",
    uploadPreset: "avatar_unsigned",
    cropping: true,
    multiple: false,
    folder: "avatars"
  }, async (error, result) => {
    if (!error && result?.event === "success") {
      const imageUrl = result.info.secure_url;
      document.getElementById("avatarPreview").src = imageUrl;

      const user = auth.currentUser;
      if (user) {
        await db.collection("users").doc(user.uid).set(
          { photoURL: imageUrl },
          { merge: true }
        );
        alert("âœ… Foto aggiornata!");
      }
    }
  });

  document.getElementById("upload_widget").addEventListener("click", () => {
    widget.open();
  });

  document.getElementById("saveProfile").addEventListener("click", async () => {
    const newName = document.getElementById("displayName").value.trim();
    const user = auth.currentUser;
    if (user && newName) {
      await db.collection("users").doc(user.uid).set(
        { displayName: newName },
        { merge: true }
      );
      alert("âœ… Nome aggiornato!");
    }
  });
</script>

</body>
</html>
