<!doctype html>
<html lang="it">
    <head>
        <meta charset="UTF-8" />
        <title>Profilo Utente</title>
        <link rel="stylesheet" href="styles.css" />

        <!-- Firebase compat -->
        <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

        <!-- Cloudinary -->
        <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>

        <style>
            .avatar {
                width: 96px;
                height: 96px;
                border-radius: 50%;
                object-fit: cover;
                border: 2px solid #ccc;
                margin: 12px 0;
            }
        </style>
    </head>
    <body>
        <div id="profile-container">
            <h2>Your Profile</h2>
            <p><strong>Email:</strong> <span id="userEmail"></span></p>

            <label for="displayName">Set your name:</label><br />
            <input type="text" id="displayName" placeholder="Enter your name" /><br /><br />

            <img id="avatarPreview" src="https://via.placeholder.com/96?text=üë§" alt="Avatar" class="avatar" /><br />
            <button id="upload_widget">üì∑ Change your profile picture</button><br /><br />
            <button id="saveProfile">üíæ Save</button><br /><br />
            <button id="goBackButton">‚Ü©Ô∏è Back</button>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const firebaseConfig = {
                    apiKey: "AIzaSyCLg-Z9YOrjsqe3PTN0Nr2C1jZotVKfI38",
                    authDomain: "todolistedo.firebaseapp.com",
                    projectId: "todolistedo",
                    storageBucket: "todolistedo.appspot.com",
                    messagingSenderId: "700684050233",
                    appId: "1:700684050233:web:755d10254e8c2cf222d2e8",
                    measurementId: "G-HR8GGBGQTJ"
                };

                firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth();
                const db = firebase.firestore();

                const emailEl = document.getElementById("userEmail");
                const avatarEl = document.getElementById("avatarPreview");
                const nameEl = document.getElementById("displayName");

                document.getElementById("goBackButton").addEventListener("click", () => {
                    if (document.referrer && !document.referrer.includes("profile.html")) {
                        history.back();
                    } else {
                        window.location.href = "index.html";
                    }
                });

                auth.onAuthStateChanged(async (user) => {
                    if (!user) return;

                    // ...codice profilo...

                    let widget;

                    // Inizializza solo una volta
                    if (!widget) {
                        widget = cloudinary.createUploadWidget(
                            {
                                cloudName: "dpj6s7xvh",
                                uploadPreset: "avatar_unsigned",
                                cropping: true,
                                multiple: false,
                                folder: "avatars"
                            },
                            async (err, result) => {
                                if (!err && result?.event === "success") {
                                    const imageUrl = result.info.secure_url;
                                    avatarEl.src = imageUrl;
                                    await userRef.set({ photoURL: imageUrl }, { merge: true });
                                    alert("‚úÖ Foto aggiornata!");
                                }
                            }
                        );
                    }

                    uploadBtn.addEventListener("click", () => {
                        if (widget) widget.open();
                        else alert("‚ö†Ô∏è Cloudinary non √® pronto. Riprova fra qualche secondo.");
                    });
                });
            });
        </script>
    </body>
</html>
